name: YouTube Playlist to Port Ingestion

on:
  workflow_dispatch:
    inputs:
      port_context:
        required: true
        description: Includes the blueprint identifier, and the action's run id
      playlist_id:
        required: true
        description: The playlist id
        type: string

jobs:
  ingest-playlist:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Fetch and Ingest YouTube Playlist to Port
        id: fetch_videos
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        run: |
          PLAYLIST_ID=${{ inputs.playlist_id }}


          nextPageToken=""
          while true; do
              response=$(curl -s "https://www.googleapis.com/youtube/v3/playlistItems?part=snippet,contentDetails&playlistId=$PLAYLIST_ID&maxResults=50&pageToken=$nextPageToken&key=$YOUTUBE_API_KEY")
              
              echo "$response" | jq -c '.items[]' | while read -r item; do
                  video_id=$(echo "$item" | jq -r '.contentDetails.videoId')
                  title=$(echo "$item" | jq -r '.snippet.title')
                  description=$(echo "$item" | jq -r '.snippet.description')
                  published_at=$(echo "$item" | jq -r '.contentDetails.videoPublishedAt')
                  channel_id=$(echo "$item" | jq -r '.snippet.channelId')
                  channel_title=$(echo "$item" | jq -r '.snippet.channelTitle')

                  video_details=$(curl -s "https://www.googleapis.com/youtube/v3/videos?part=statistics,contentDetails&id=$video_id&key=$YOUTUBE_API_KEY")
                  duration=$(echo "$video_details" | jq -r '.items[0].contentDetails.duration')
                  view_count=$(echo "$video_details" | jq -r '.items[0].statistics.viewCount | tonumber')
                  like_count=$(echo "$video_details" | jq -r '.items[0].statistics.likeCount | tonumber')
                  comment_count=$(echo "$video_details" | jq -r '.items[0].statistics.commentCount | tonumber')

                  data=$(jq -n --arg identifier "$video_id" \
                                     --arg title "$title" \
                                     --arg description "$description" \
                                     --arg published_at "$published_at" \
                                     --arg channel_id "$channel_id" \
                                     --arg channel_title "$channel_title" \
                                     --arg duration "$duration" \
                                     --arg view_count "$view_count" \
                                     --arg like_count "$like_count" \
                                     --arg comment_count "$comment_count" \
                                     '{
                                         identifier: $identifier,
                                         title: $title,
                                         properties: {
                                             id: $identifier,
                                             description: $description,
                                             title: $title,
                                             published_at: $published_at,
                                             channel_id: $channel_id,
                                             channel_title: $channel_title,
                                             duration: $duration,
                                             view_count: $view_count,
                                             like_count: $like_count,
                                             comment_count: $comment_count
                                         },
                                         relations: {}
                                     }')

                   video=$(jq -n --arg identifier "$video_id" \
                                     --arg title "$title" \
                                     --arg description "$description" \
                                     --arg published_at "$published_at" \
                                     --arg channel_id "$channel_id" \
                                     --arg channel_title "$channel_title" \
                                     --arg duration "$duration" \
                                     --arg view_count "$view_count" \
                                     --arg like_count "$like_count" \
                                     --arg comment_count "$comment_count" \
                                     '{
                                         identifier: $identifier,
                                         title: $title,
                                         id: $identifier,
                                         description: $description,
                                         title: $title,
                                         published_at: $published_at,
                                         channel_id: $channel_id,
                                         channel_title: $channel_title,
                                         duration: $duration,
                                         view_count: $view_count,
                                         like_count: $like_count,
                                         comment_count: $comment_count
                                         
                                     }')
                  

                                     
      

                  # Add data to output
                  

                  video=$(echo "$video" | sed ':a;N;$!ba;s/\n/\\n/g' | sed 's/"/\\"/g')
                  echo "$video"
                  echo "$title"
                  echo "video=$video" >> $GITHUB_OUTPUT

                   
                  video_id=$(echo "$video_id" | sed ':a;N;$!ba;s/\n/\\n/g' | sed 's/"/\\"/g')
                  echo "video_id=$video_id" >> $GITHUB_OUTPUT

                  title=$(echo "$title" | sed ':a;N;$!ba;s/\n/\\n/g' | sed 's/"/\\"/g')
                  echo "title=$title" >> $GITHUB_OUTPUT

                  description=$(echo "$description" | sed ':a;N;$!ba;s/\n/\\n/g' | sed 's/"/\\"/g')
                  echo "description=$description" >> $GITHUB_OUTPUT

                  published_at=$(echo "$published_at" | sed ':a;N;$!ba;s/\n/\\n/g' | sed 's/"/\\"/g')
                  echo "published_at=$published_at" >> $GITHUB_OUTPUT

                  channel_id=$(echo "$channel_id" | sed ':a;N;$!ba;s/\n/\\n/g' | sed 's/"/\\"/g')
                  echo "channel_id=$channel_id" >> $GITHUB_OUTPUT

                  channel_title=$(echo "$channel_title" | sed ':a;N;$!ba;s/\n/\\n/g' | sed 's/"/\\"/g')
                  echo "channel_title=$channel_title" >> $GITHUB_OUTPUT

                  duration=$(echo "$duration" | sed ':a;N;$!ba;s/\n/\\n/g' | sed 's/"/\\"/g')
                  echo "duration=$duration" >> $GITHUB_OUTPUT

                  view_count=$(echo "$view_count" | sed ':a;N;$!ba;s/\n/\\n/g' | sed 's/"/\\"/g')
                  echo "view_count=$view_count" >> $GITHUB_OUTPUT

                  like_count=$(echo "$like_count" | sed ':a;N;$!ba;s/\n/\\n/g' | sed 's/"/\\"/g')
                  echo "like_count=$like_count" >> $GITHUB_OUTPUT

                  comment_count=$(echo "$comment_count" | sed ':a;N;$!ba;s/\n/\\n/g' | sed 's/"/\\"/g')
                  echo "comment_count=$comment_count" >> $GITHUB_OUTPUT

                  
                 # echo "$data"
                #  echo "$title"
                  
                
              done

              nextPageToken=$(echo "$response" | jq -r '.nextPageToken')
              [ "$nextPageToken" == "null" ] && break
          done
          
          # Escape newlines and special characters
          data=$(echo "$data" | sed ':a;N;$!ba;s/\n/\\n/g' | sed 's/"/\\"/g')
          
          echo "data=$data" >> $GITHUB_OUTPUT

      - name: Debug the Output Values
        run: |
          echo "Video ID: ${{ steps.fetch_videos.outputs.video_id }}"
          echo "Title: ${{ steps.fetch_videos.outputs.title }}"
          echo "Description: ${{ steps.fetch_videos.outputs.description }}"
          echo "Published at: ${{ steps.fetch_videos.outputs.published_at }}"
          echo "Channel ID: ${{ steps.fetch_videos.outputs.channel_id }}"
          echo "Channel Title: ${{ steps.fetch_videos.outputs.channel_title }}"
          echo "Duration: ${{ steps.fetch_videos.outputs.duration }}"
      

      - name: UPSERT playlist
        uses: port-labs/port-github-action@v1
        with:
          identifier: "${{ steps.fetch_videos.outputs.video_id }}"
          title: "${{ steps.fetch_videos.outputs.title }}"
          blueprint: ${{ fromJson(inputs.port_context).blueprint }}
          properties: |
            {
              "description": "${{ steps.fetch_videos.outputs.description }}",
              "published_at": "${{ steps.fetch_videos.outputs.published_at }}",
              "channel_id": "${{ steps.fetch_videos.outputs.channel_id }}",
              "channel_title": "${{ steps.fetch_videos.outputs.channel_title }}",
              "duration": "${{ steps.fetch_videos.outputs.duration }}",
              "view_count": "${{ steps.fetch_videos.outputs.view_count }}",
              "like_count": "${{ steps.fetch_videos.outputs.like_count }}",
              "comment_count": "${{ steps.fetch_videos.outputs.comment_count }}"
            }
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.getport.io
          operation: UPSERT
          runId: ${{ fromJson(inputs.port_context).run_id }}
